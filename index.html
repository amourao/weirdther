<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weirdther Widget</title>
    <script src="app.js"></script>
    <link rel="stylesheet" href="widget.css">
</head>
<body>
    <div class="widget-container">
        <div id="loading" class="loading"></div>
        <div id="widget-content" style="display: none;">
            <div class="header">
                <div class="date-section">
                    <div class="selected-day" id="selectedDay">Today</div>
                    <div class="weirdther-today">
                        <div class="weirdther-today-label">Weirdther score</div>
                        <div class="weirdther-today-value" id="currentWeirdther">--</div>
                        <div>
                            <a href="#" id="detailedLink" class="detailed-link" style="display:none;">Details</a>
                        </div>
                    </div>
                </div>
                <div class="current-weather">
                    <div class="weather-icon" id="weatherIcon">üå§Ô∏è</div>
                    <div>
                        <div class="forecast-temp" id="currentRange">
                            <span class="forecast-temp-high" id="currentRangeHigh"></span>
                            <span class="forecast-temp-low" id="currentRangeLow"></span>
                        </div>
                        <div class="current-metrics" id="currentMetrics"></div>
                    </div>
                </div>
                <div class="location-info">
                    <div class="unit-selector">
                        <button class="unit-button" id="metricBtn" onclick="switchUnit('metric')">Metric</button>
                        <button class="unit-button" id="imperialBtn" onclick="switchUnit('imperial')">Imperial</button>
                    </div>
                    <input type="text" 
                           id="locationInput" 
                           class="location-input"
                           placeholder="Enter location"
                           onchange="updateLocation(this.value)"
                           onkeypress="if(event.key === 'Enter') { this.blur(); }"
                    />
                    <div id="geocode_result" class="coordinates"></div>
                    <div id="location" style="display:none;"></div>
                    <div class="coordinates">
                    <span id="latitude">--</span>
                    <span id="longitude">--</span>
                    </div>
                    <div class="condition" id="condition">--</div>
                </div>
                <div id="date" style="display:none;"></div>
                <div id="delta" style="display:none;"></div>
                <div id="units" style="display:none;"></div>
                <div id="summary" style="display:none;"></div>
                <div id="chart" style="display:none;"></div>
                <div id="climate_normal" style="display:none;"></div>
            </div>

            <div class="forecast-section">
                <div class="section-title">5-Day Forecast</div>
                <div class="forecast-grid" id="forecastGrid"></div>
            </div>
        </div>
    </div>

    <script>

        // Store the weather data globally
        let widgetWeatherData = null;

        // Override the original getWeather to capture data
        const originalGetWeather = getWeather;
        getWeather = async function() {
            await originalGetWeather();
            // After data is loaded, extract it for the widget
            initializeWidget();
        };

        function getWeatherIcon(rain, snow, sunshine) {
            if (snow > 0.2) return 'üå®';
            if (rain > 5) return 'üåßÔ∏è';
            if (rain > 0.2) return 'üå¶Ô∏è';
            if (sunshine > 0.8) return '‚òÄÔ∏è';
            if (sunshine > 0.66) return 'üå§Ô∏è';
            if (sunshine > 0.33) return '‚õÖ';
            return '‚òÅÔ∏è';
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }

        function getPercentileBarHTML(percentile) {
            // Calculate distance from median (0.5)
            const distanceFromMedian = Math.abs(percentile - 0.5);
            const width = distanceFromMedian * 100; // Width is distance from center (0-50%)
            
            if (percentile > 0.5) {
                // Above median - bar extends to the right
                return `<div class="percentile-fill above-median" style="width: ${width}%"></div>`;
            } else {
                // Below median - bar extends to the left
                return `<div class="percentile-fill below-median" style="width: ${width}%"></div>`;
            }
        }

        function initializeWidget() {
            // Get data from the global variables set by app.js
            if (!window.widgetData) {
                console.error('No widget data available');
                return;
            }

            const data = window.widgetData;
            
            // Update location info - populate the input field
            document.getElementById('locationInput').value = data.parameters.location;
            document.getElementById('location').value = data.parameters.location;
            document.getElementById('latitude').textContent = `${data.parameters.latitude}¬∞${data.parameters.latitude < 0 ? 'S' : 'N'}`;
            document.getElementById('longitude').textContent = `${Math.abs(data.parameters.longitude)}¬∞${data.parameters.longitude < 0 ? 'W' : 'E'}`;
            document.getElementById('condition').textContent = getConditionText(data.results["Selected day"]);

            // Update detailed view link with current parameters
            updateDetailedLink(data.parameters.date);

            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('widget-content').style.display = 'block';

            // Render forecast
            renderForecast(data);
            
            // Initialize with today's data
            showDetails(0);
        }

        function updateDetailedLink(date) {
            const params = new URLSearchParams();
            
            // Get values from the widget data if available
            if (window.widgetData) {
                const data = window.widgetData.parameters;
                
                if (data.location) params.append('location', data.location);
                if (data.latitude) params.append('latitude', data.latitude);
                if (data.longitude) params.append('longitude', data.longitude);
                
                if (date) params.append('date', date);
                else if (data.date) params.append('date', data.date);
            
                if (data.delta) params.append('delta', data.delta);
                if (data.units) params.append('units', data.units);
                if (data.climate_normal) params.append('climate_normal', data.climate_normal);
            }
            
            // Build URL and update link
            const detailedUrl = `detailed.html?${params.toString()}`;
            const detailedLink = document.getElementById('detailedLink');
            detailedLink.href = detailedUrl;
            detailedLink.style.display = 'inline-block';
        }

        function getConditionText(dayData) {
            const rain = dayData.rain_sum[0];
            const snow = dayData.snowfall_sum ? dayData.snowfall_sum[0] : 0;
            const sunshine = dayData.sunshine_duration[0];
            
            if (snow > 0) return 'Snowy';
            if (rain > 20) return 'Rainy';
            if (rain > 0 && rain < 5) return 'Light Rain';
            if (sunshine > 0.7) return 'Sunny';
            if (sunshine > 0.3) return 'Partly Cloudy';
            return 'Cloudy';
        }

        function getPercentilePretty(value) {
            var valueInt = Math.round(value * 100)
            if (valueInt < 0)
                valueInt = 0;
            if (valueInt > 100)
                valueInt = 100;
            if (valueInt == 1) return "1st";
            if (valueInt == 2) return "2nd";
            if (valueInt == 3) return "3rd";
            return valueInt + "th";
        }

        function renderForecast(weatherData) {
            const forecastGrid = document.getElementById('forecastGrid');
            const todayData = weatherData.results["Selected day"];
            const futureData = weatherData.results["Days after"];
            
            // Combine today and future days
            const allDays = {
                time: [todayData.time[0], ...futureData.time],
                temperature_2m_max: [todayData.temperature_2m_max[0], ...futureData.temperature_2m_max],
                temperature_2m_min: [todayData.temperature_2m_min[0], ...futureData.temperature_2m_min],
                rain_sum: [todayData.rain_sum[0], ...futureData.rain_sum],
                wind_speed_10m_max: [todayData.wind_speed_10m_max[0], ...futureData.wind_speed_10m_max],
                sunshine_duration: [todayData.sunshine_duration[0], ...futureData.sunshine_duration],
                percentiles: {
                    temperature_2m_max: [todayData.percentiles.temperature_2m_max[0], ...futureData.percentiles.temperature_2m_max],
                    temperature_2m_min: [todayData.percentiles.temperature_2m_min[0], ...futureData.percentiles.temperature_2m_min],
                    rain_sum: [todayData.percentiles.rain_sum[0], ...futureData.percentiles.rain_sum],
                    wind_speed_10m_max: [todayData.percentiles.wind_speed_10m_max[0], ...futureData.percentiles.wind_speed_10m_max],
                    sunshine_duration: [todayData.percentiles.sunshine_duration[0], ...futureData.percentiles.sunshine_duration],
                    snowfall_sum: todayData.percentiles.snowfall_sum ? [todayData.percentiles.snowfall_sum[0], ...(futureData.percentiles.snowfall_sum || [])] : null
                },
                weirdther_score: [todayData.weirdther_score[0], ...futureData.weirdther_score],
                snowfall_sum: todayData.snowfall_sum ? [todayData.snowfall_sum[0], ...(futureData.snowfall_sum || [])] : null
            };
            
            forecastGrid.innerHTML = allDays.time.map((date, index) => {
                const tempMax = allDays.temperature_2m_max[index];
                const tempMin = allDays.temperature_2m_min[index];
                const rain = allDays.rain_sum[index];
                const snow = allDays.snowfall_sum ? allDays.snowfall_sum[index] : 0;
                const wind = allDays.wind_speed_10m_max[index];
                const sunshine = allDays.sunshine_duration[index];
                const weirdScore = allDays.weirdther_score[index];
                
                const percentiles = {
                    tempMax: parseFloat(allDays.percentiles.temperature_2m_max[index]),
                    tempMin: parseFloat(allDays.percentiles.temperature_2m_min[index]),
                    rain: parseFloat(allDays.percentiles.rain_sum[index]),
                    wind: parseFloat(allDays.percentiles.wind_speed_10m_max[index]),
                    sunshine: parseFloat(allDays.percentiles.sunshine_duration[index]),
                    snow: allDays.percentiles.snowfall_sum ? parseFloat(allDays.percentiles.snowfall_sum[index]) : 0
                };

                const icon = getWeatherIcon(rain, snow, sunshine);
                const weirdClass = weirdScore == 100 ? 'extreme-weird' : (weirdScore > 70 ? 'high-weird' : (weirdScore < 30 ? 'low-weird' : 'moderate-weird'));
                const weirdLabel = weirdScore == 100 ? 'UNPRECEDENTED' : (weirdScore > 70 ? 'UNUSUAL' : (weirdScore < 30 ? 'TYPICAL' : 'MODERATE'));

                // Build precipitation string
                let precipString = '';
                if (rain > 0 || snow > 0) {
                    const parts = [];
                    if (rain > 0) parts.push(`üíß ${rain.toFixed(1)}${FRIENDLY_NAMES["rain_sum"][getDefaultUnit()+"_short"]}`);
                    if (snow > 0) parts.push(`‚ùÑÔ∏è ${snow.toFixed(1)}${FRIENDLY_NAMES["snowfall_sum"][getDefaultUnit()+"_short"]}`);
                    precipString = parts.join(' ');
                }

                // Sunshine first, then precipitation
                const sunshineAndPrecip = `‚òÄÔ∏è ${Math.round(sunshine * 100)}%` + (precipString ? '  ' + precipString : '');

                const isToday = new Date(date).toDateString() === new Date().toDateString();
                const dateLabel = isToday ? 'Today' : formatDate(date);

                return `
                    <div class="forecast-card ${weirdClass} ${isToday ? 'active' : ''}" onclick="showDetails(${index})" data-index="${index}">
                        ${weirdClass ? `<div class="weird-badge">${weirdLabel}</div>` : ''}
                        <div class="forecast-date">${dateLabel}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temps">
                            <span class="forecast-temp-high">${Math.round(tempMax)}¬∞</span>
                            <span class="forecast-temp-low">${Math.round(tempMin)}¬∞</span>
                        </div>
                        <div class="rain-indicator">${sunshineAndPrecip}</div>
                        <div class="percentile-bars">
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Max Temp</span>
                                    <span>${getPercentilePretty(percentiles.tempMax)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.tempMax)}
                                </div>
                            </div>
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Min Temp</span>
                                    <span>${getPercentilePretty(percentiles.tempMin)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.tempMin)}
                                </div>
                            </div>
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Rain</span>
                                    <span>${getPercentilePretty(percentiles.rain)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.rain)}
                                </div>
                            </div>
                            ${allDays.snowfall_sum ? `
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Snow</span>
                                    <span>${getPercentilePretty(percentiles.snow)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.snow)}
                                </div>
                            </div>
                            ` : ''}
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Wind</span>
                                    <span>${getPercentilePretty(percentiles.wind)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.wind)}
                                </div>
                            </div>
                            <div class="percentile-item">
                                <div class="percentile-label">
                                    <span>Sunshine</span>
                                    <span>${getPercentilePretty(percentiles.sunshine)}</span>
                                </div>
                                <div class="percentile-bar">
                                    <div class="percentile-bar-center"></div>
                                    ${getPercentileBarHTML(percentiles.sunshine)}
                                </div>
                            </div>
                        </div>
                        <div class="weirdther-score">
                            <div class="weirdther-label">Weirdther score</div>
                            <div class="weirdther-value" style="color: ${weirdScore > 70 ? '#ff6b6b' : (weirdScore < 30 ? '#4ecdc4' : '#ffa502')}">${Math.round(weirdScore)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Store all days data globally for showDetails to use
            window.allDaysData = allDays;
        }

        function showDetails(index) {
            const data = window.allDaysData;
            
            const tempMax = data.temperature_2m_max[index];
            const tempMin = data.temperature_2m_min[index];
            const rain = data.rain_sum[index];
            const snow = data.snowfall_sum ? data.snowfall_sum[index] : 0;
            const wind = data.wind_speed_10m_max[index];
            const sunshine = data.sunshine_duration[index];
            const weirdScore = data.weirdther_score[index];
            
            // Update selected day display
            const selectedDayElement = document.getElementById('selectedDay');
            if (new Date(data.time[index]).toDateString() === new Date().toDateString()) {
                selectedDayElement.textContent = 'Today';
            } else {
                selectedDayElement.textContent = formatDate(data.time[index]);
            }
            
            // Update weather icon
            const icon = getWeatherIcon(rain, snow, sunshine);
            document.getElementById('weatherIcon').textContent = icon;
            
            // Update condition
            document.getElementById('condition').textContent = getConditionFromData(rain, snow, sunshine);
            
            // Update temperature range
            document.getElementById('currentRangeHigh').textContent = `${Math.round(tempMax)}¬∞`;
            document.getElementById('currentRangeLow').textContent = `${Math.round(tempMin)}¬∞`;
            
            // Update weirdther score
            const weirdtherElement = document.getElementById('currentWeirdther');
            weirdtherElement.textContent = Math.round(weirdScore);
            weirdtherElement.style.color = weirdScore > 70 ? '#ff6b6b' : (weirdScore < 30 ? '#4ecdc4' : '#ffa502');
            
            // Update metrics
            const currentMetrics = document.getElementById('currentMetrics');
            let metricsHTML = `
                <div class="metric-item">üíß ${rain.toFixed(1)}${FRIENDLY_NAMES["rain_sum"][getDefaultUnit()+"_short"]}</div>
            `;
            
            if (snow > 0) {
                metricsHTML += `<div class="metric-item">‚ùÑÔ∏è ${snow.toFixed(1)}${FRIENDLY_NAMES["snowfall_sum"][getDefaultUnit()+"_short"]}</div>`;
            }
            
            metricsHTML += `
                <div class="metric-item">üí® ${Math.round(wind)}${FRIENDLY_NAMES["wind_speed_10m_max"][getDefaultUnit()+"_short"]}</div>
                <div class="metric-item">‚òÄÔ∏è ${Math.round(sunshine * 100)}%</div>
            `;
            
            currentMetrics.innerHTML = metricsHTML;

            updateDetailedLink(data.time[index]);
            
            // Update active state on cards
            document.querySelectorAll('.forecast-card').forEach((card, i) => {
                if (i === index) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });
        }

        function getConditionFromData(rain, snow, sunshine) {
            if (snow > 0) return 'Snowy';
            if (rain > 5) return 'Rainy';
            if (rain > 0) return 'Light Rain';
            if (sunshine > 0.7) return 'Sunny';
            if (sunshine > 0.3) return 'Partly Cloudy';
            return 'Cloudy';
        }

        function updateLocation(newLocation) {
            // Update the hidden location field
            document.getElementById('location').value = newLocation;
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            
            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('widget-content').style.display = 'none';
            
            console.log("Updating location to:", newLocation);
            // Trigger weather data reload
            if (newLocation.trim() == '') {
                navigator.geolocation.getCurrentPosition(function(position) {
                    console.log("Using current location coordinates:", position.coords.latitude, position.coords.longitude);
                    document.getElementById("latitude").value = position.coords.latitude.toFixed(2);
                    document.getElementById("longitude").value = position.coords.longitude.toFixed(2);
                    document.getElementById("location").value = "Current location";
                    getWeather();
                }); 
            } else {
                getWeather();
            }
        }

        function getDefaultUnit() {
            // check if unit is in localStorage 
            const storedUnit = localStorage.getItem('unit');
            if (storedUnit) {
                return storedUnit;
            }
            if (document.getElementById("units") && document.getElementById("units").value) {
                return document.getElementById("units").value;
            }
            const locale = navigator.language || navigator.userLanguage || "-";
            const country = locale.split('-')[1] || locale;
            const imperialCountries = ['US', 'LR', 'MM'];
            const unit = imperialCountries.includes(country.toUpperCase()) ? 'imperial' : 'metric';
            console.log("Detected locale:", locale, "Country:", country, "Using unit:", unit);
            return unit;
        }

        function setDefaultUnit(unit) {
            localStorage.setItem('unit', unit);
        }

        function switchUnit(unit) {
            // Save the preference
            setDefaultUnit(unit);
            
            // Update the hidden field
            document.getElementById('units').value = unit;
            
            // Update button states
            updateUnitButtons();
            
            // Reload weather data with new units
            document.getElementById('loading').style.display = 'block';
            document.getElementById('widget-content').style.display = 'none';
            getWeather();
        }

        function updateUnitButtons() {
            const currentUnit = getDefaultUnit();
            const metricBtn = document.getElementById('metricBtn');
            const imperialBtn = document.getElementById('imperialBtn');
            
            if (currentUnit === 'metric') {
                metricBtn.classList.add('active');
                imperialBtn.classList.remove('active');
            } else {
                imperialBtn.classList.add('active');
                metricBtn.classList.remove('active');
            }

        }

        window.onload = async function() {
            // Get the default unit (from localStorage or locale detection)
            const defaultUnit = getDefaultUnit();
            
            // set default parameters for hidden fields
            document.getElementById('date').value = document.getElementById('date').innerHTML || new Date().toISOString().split('T')[0];
            document.getElementById('delta').value = document.getElementById('delta').innerHTML || '5';
            document.getElementById('units').value = defaultUnit;
            
            // Update button states
            updateUnitButtons();
            
            await start();
            initializeWidget();
        };
    </script>
</body>
</html>
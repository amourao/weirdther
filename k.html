<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Weirdther</title>
<script src="weirdther-core.js"></script>
<script src="weather-icons-eink.js"></script>
<style>
body { margin: 0; padding: 0; background: white; color: black; }
#wrapper { padding: 18px 22px; font-family: Helvetica, Arial, sans-serif; -webkit-box-sizing: border-box; box-sizing: border-box; overflow: hidden; }
#header { font-size: 42px; padding-bottom: 6px; border-bottom: 3px solid black; margin-bottom: 10px; }
.hdr-row { border: none; width: 100%; }
.hdr-row td { border: none; padding: 0; font-size: 42px; }
.hdr-right { text-align: right; white-space: nowrap; width: 1px; }
#loading { font-size: 48px; padding: 30px 0; }
#error { font-size: 48px; font-weight: bold; }
.progress-container { width: 100%; height: 60px; background: #ddd; border: 2px solid black; margin: 20px 0; position: relative; }
.progress-bar { height: 100%; background: black; width: 0%; transition: width 0.3s ease; }
.progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 36px; font-weight: bold; color: #333; }
/* Vars + Score side by side */
.vars-row { border: none; width: 100%; margin: 0; }
.vars-row td { border: none; padding: 0; vertical-align: top; }
.score-box { text-align: right; white-space: nowrap; padding-left: 12px; }
.score-num { font-size: 156px; font-weight: bold; line-height: 1; padding: 0 6px; }
.score-lbl { font-size: 66px; font-weight: bold; letter-spacing: 2px; padding: 0 6px; }
.score-num-inv { font-size: 156px; font-weight: bold; line-height: 1; padding: 0 6px; color: white; background: black; display: inline-block; }
.score-weirdther { font-size: 48px;}
.score-freq { font-size: 48px; color: #333; }
/* Variable breakdown */
table.vars { border-collapse: collapse; width: 100%; margin: 0; }
table.vars td { border: none; padding: 2px 6px; font-size: 52px; }
table.vars .vi { font-size: 54px; text-align: center; width: 56px; }
table.vars .pct { color: #333; text-align: right; }
table.vars .bld td { font-weight: bold; color: white; background: black; }
table.vars .bld-lo td { font-weight: bold; color: white; background: gray; }
/* Forecast */
table.fc { border-collapse: collapse; width: 100%; border: 2px solid black; }
table.fc th, table.fc td { border: none; padding: 5px 7px; text-align: right; font-size: 40px; }
table.fc th { background: #bbb; color: black; font-size: 36px; }
table.fc th:first-child, table.fc td:first-child { width: 1px; white-space: nowrap; padding: 5px 4px; }
table.fc .day-col { text-align: left; }
table.fc .icon-col { text-align: center; width: 52px; padding: 4px 2px; }
.hdr-right .icon-col { display: inline-block; vertical-align: middle; }
table.fc .bld { font-weight: bold; color: white; background: black; }
table.fc .bld-lo { font-weight: bold; color: white; background: gray; }
table.fc a { color: black; text-decoration: underline; }
/* Header controls */
.loc-form { margin: 0; padding: 0; width: 100%; white-space: nowrap; }
.loc-input { width: calc(100% - 80px); font-size: 36px; border: 1px solid gray; padding: 2px 6px; -webkit-box-sizing: border-box; box-sizing: border-box; vertical-align: top; }
.go-btn { width: 70px; font-size: 36px; border: 1px solid gray; padding: 2px 8px; vertical-align: top; margin-left: -4px; }
.score-refresh { font-size: 36px; color: #555; }
</style>
</head>
<body>
<div id="wrapper">
<div id="header"></div>
<div id="loading"></div>
<div id="error"></div>
<div id="results"></div>
</div>

<script>
/* ========== CONFIGURATION ========== */
var VAR_LIST = WEIRDTHER_CONFIG.DAILY_VARS.split(",");
var DEFAULT_DELTA = 5;
var NUM_FORECAST_DAYS = 6;
var HISTORICAL_YEARS = 26;
var SCORE_VARS = WEIRDTHER_CONFIG.SCORE_VARS;
/* FRIENDLY is derived from FRIENDLY_NAMES (weirdther-core.js). Overrides
   use shorter names and &deg; entities for e-ink legibility. */
var FRIENDLY_OVERRIDES = {
    "temperature_2m_max": {name: "Max", metric: "&deg;C", imperial: "&deg;F"},
    "temperature_2m_min": {name: "Min", metric: "&deg;C", imperial: "&deg;F"},
    "rain_sum":           {metric: "mm", imperial: "in"},
    "snowfall_sum":       {metric: "mm", imperial: "in"},
    "wind_speed_10m_max": {metric: "km/h", imperial: "mph"},
    "sunshine_duration":  {name: "Sun", metric: "%", imperial: "%"}
};
var FRIENDLY = {};
for (var _vn in FRIENDLY_NAMES) {
    if (!FRIENDLY_NAMES.hasOwnProperty(_vn)) continue;
    var _ov = FRIENDLY_OVERRIDES[_vn] || {};
    FRIENDLY[_vn] = {
        name:     _ov.name     !== undefined ? _ov.name     : FRIENDLY_NAMES[_vn].name,
        lower:    FRIENDLY_NAMES[_vn].lower,
        higher:   FRIENDLY_NAMES[_vn].higher,
        metric:   _ov.metric   !== undefined ? _ov.metric   : FRIENDLY_NAMES[_vn].metric_short,
        imperial: _ov.imperial !== undefined ? _ov.imperial : FRIENDLY_NAMES[_vn].imperial_short
    };
}

var VAR_ICONS = {
    "temperature_2m_max": "&#9650;",
    "temperature_2m_min": "&#9660;",
    "rain_sum": "&#9730;",
    "snowfall_sum": "&#9731;",
    "wind_speed_10m_max": "&#8776;",
    "sunshine_duration": "&#9728;"
};

var currentLat = null;
var currentLon = null;
var currentUnits = "metric";
var currentDateStr = "";
var locationName = "";

/* ========== CACHE ========== */

function getDefaultUnit() {
    if (!useCache) {
        var locale = navigator.language || navigator.userLanguage || "-";
        var country = locale.split('-')[1] || locale;
        var imperialCountries = ['US', 'LR', 'MM'];
        return imperialCountries.indexOf(country.toUpperCase()) !== -1 ? 'imperial' : 'metric';
    }
    try {
        var storedUnit = localStorage.getItem('unit');
        if (storedUnit) return storedUnit;
    } catch (e) {}
    var locale = navigator.language || navigator.userLanguage || "-";
    var country = locale.split('-')[1] || locale;
    var imperialCountries = ['US', 'LR', 'MM'];
    return imperialCountries.indexOf(country.toUpperCase()) !== -1 ? 'imperial' : 'metric';
}

function setDefaultUnit(unit) {
    if (!useCache) return;
    try {
        localStorage.setItem('unit', unit);
    } catch (e) {}
}


/* ========== UTILITY ========== */

// parseUrlParams is provided by weirdther-core.js

function show(id, text) {
    var el = document.getElementById(id);
    if (!el) return;
    el.innerHTML = text;
    el.style.display = text ? "" : "none";
}

function showProgress(message, percent) {
    var el = document.getElementById("loading");
    if (!el) return;
    var pct = Math.round(percent);
    el.innerHTML = '<div>' + message + '</div>' +
        '<div class="progress-container">' +
        '<div class="progress-bar" style="width: ' + pct + '%"></div>' +
        '</div>';
    el.style.display = "";
}

function formatDateShort(dateStr) {
    var d = parseDate(dateStr);
    var days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    return days[d.getDay()] + " " + d.getDate() + " " + months[d.getMonth()];
}


/* ========== API ========== */

/* fetchForecast, fetchHistoricalRange, fetchHistoricalYear, fetchAllHistorical,
   mergeForecastHistorical are provided by weirdther-core.js */

/* ========== DATA PROCESSING ========== */

function allZero(arr) {
    for (var i = 0; i < arr.length; i++) {
        if (arr[i] != null && arr[i] > 0) return false;
    }
    return true;
}


function computeAllDayScores(forecastDaily, todayIndex, numDays, historicalGrouped, latitude, units, delta, climateNormal) {
    delta = delta || WEIRDTHER_CONFIG.DEFAULT_DELTA;
    climateNormal = climateNormal || {start: 2000, end: 2030};

    var allScores = [];
    for (var d = 0; d < numDays; d++) {
        var idx = todayIndex + d;
        if (idx >= forecastDaily.time.length) break;

        var ds = {
            date: forecastDaily.time[idx],
            tempMax: forecastDaily.temperature_2m_max[idx],
            tempMin: forecastDaily.temperature_2m_min[idx],
            rain: forecastDaily.rain_sum[idx] || 0,
            snow: forecastDaily.snowfall_sum[idx] || 0,
            wind: forecastDaily.wind_speed_10m_max[idx] || 0,
            sunshinePct: forecastDaily.sunshine_duration[idx] || 0,
            weirdther: 0,
            maxPercentile: 0.5,
            vars: {}
        };

        var varScores = [];
        var maxPctile = 0.5;

        for (var v = 0; v < SCORE_VARS.length; v++) {
            var varName = SCORE_VARS[v];
            var curVal = forecastDaily[varName][idx];
            if (curVal == null) continue;

            // Filter historical data by day-of-year window and climate normal years
            var filtered = filterHistoricalByDateWindow(
                historicalGrouped[varName],
                historicalGrouped["time"],
                ds.date,
                delta,
                climateNormal
            );

            var result = computeVariableScore(varName, filtered.values, filtered.dates, curVal, ds.date, latitude);

            if (filtered.values.length === 0) continue;

            var pctile = result.percentile;
            var score = result.score;

            var qualifier = "";
            if (pctile < 0) qualifier = FRIENDLY[varName].lower + "!";
            else if (pctile > 1) qualifier = FRIENDLY[varName].higher + "!";
            else if (pctile < 0.05) qualifier = "very " + FRIENDLY[varName].lower;
            else if (pctile > 0.95) qualifier = "very " + FRIENDLY[varName].higher;
            else if (pctile < 0.25) qualifier = FRIENDLY[varName].lower;
            else if (pctile > 0.75) qualifier = FRIENDLY[varName].higher;

            var dispPctile = pctile;
            if (dispPctile < 0) dispPctile = 0;
            if (dispPctile > 1) dispPctile = 1;

            var dispValue = curVal;
            if (varName === "sunshine_duration") dispValue = ds.sunshinePct;

            ds.vars[varName] = {
                raw: dispPctile,
                score: score,
                qualifier: qualifier,
                value: dispValue
            };

            if (isScoreVar(varName)) {
                varScores.push({ varName: varName, score: score });
                var absPctile = Math.abs(pctile - 0.5) + 0.5;
                if (absPctile > maxPctile) maxPctile = absPctile;
            }
        }

        ds.weirdther = computeFinalWeirdtherScore(varScores);
        ds.maxPercentile = maxPctile;
        allScores.push(ds);
    }
    return allScores;
}

/* ========== RENDERING ========== */


function buildPageUrl(overrides) {
    var params = parseUrlParams();
    var keys = ["location", "latitude", "longitude", "units", "date", "rotation", "scale"];
    var i, k;
    for (i = 0; i < keys.length; i++) {
        k = keys[i];
        if (overrides[k] !== undefined) params[k] = overrides[k];
    }

    var qs = buildUrlQuery(params, keys);
    return window.location.pathname + qs;
}

function goLocation() {
    var inp = document.getElementById("loc-input");
    if (!inp || !inp.value) return;
    window.location.href = buildPageUrl({"location": inp.value, "latitude": "", "longitude": "", "date": ""});
}

function formatTime(d) {
    var h = d.getHours();
    var m = d.getMinutes();
    var day = d.getDate();
    var month = d.getMonth() + 1;
    var year = d.getFullYear();
    return year + "-" + (month < 10 ? "0" : "") + month + "-" + (day < 10 ? "0" : "") + day + " " +
           (h < 10 ? "0" : "") + h + ":" + (m < 10 ? "0" : "") + m;
}

function buildDateLink(dateStr) {
    var params = parseUrlParams();
    params.date = dateStr;
    var keys = ["location", "latitude", "longitude", "units", "rotation", "scale", "date"];
    return buildUrlQuery(params, keys);
}

function fmtVal(varName, value, units) {
    if (varName === "sunshine_duration") return Math.round(value) + "%";
    if (varName === "temperature_2m_max" || varName === "temperature_2m_min") return Math.round(value) + FRIENDLY[varName][units];
    if (varName === "wind_speed_10m_max") return Math.round(value) + FRIENDLY[varName][units];
    return (value != null ? value.toFixed(1) : "0") + FRIENDLY[varName][units];
}

function renderAll(dayScores, units, startYear, endYear, hideVars, selectedDate, weatherCodes) {
    weatherCodes = weatherCodes || {};
    var html = "";
    var nowStr = toISODate(new Date());

    // Find the selected day in dayScores (may not be index 0 if yesterday is included)
    var selectedIdx = 0;
    for (var si = 0; si < dayScores.length; si++) {
        if (dayScores[si].date === selectedDate) { selectedIdx = si; break; }
    }
    var today = dayScores[selectedIdx];

    var isToday = (today.date === nowStr);
    var todayWxCode = weatherCodes[today.date];
    var wxIcon = '<span class="icon-col" title="' + (todayWxCode != null ? weatherCodeToDescription(todayWxCode) : "") + '">' + getWeatherIconEink(todayWxCode) + '</span>' 
    var label = getScoreLabel(today.weirdther);
    var dateLabel = isToday ? "Today" : formatDateShort(today.date);
    var hideRain = !!hideVars["rain_sum"];
    var hideSnow = !!hideVars["snowfall_sum"];

    /* ---- Update header: location input left, units+weather right ---- */
    var escapedName = locationName.replace(/"/g, '&quot;');
    var metricUrl = buildPageUrl({"units": "metric"});
    var imperialUrl = buildPageUrl({"units": "imperial"});
    var unitC = units === "metric" ? "<b>C</b>" : '<a href="' + metricUrl + '">C</a>';
    var unitF = units === "imperial" ? "<b>F</b>" : '<a href="' + imperialUrl + '">F</a>';
    show("header", '<table class="hdr-row"><tr>' +
        '<td><form onsubmit="goLocation();return false;" class="loc-form"><input id="loc-input" class="loc-input" value="' + escapedName + '"><input type="submit" value="Go" class="go-btn"></form></td>' +
        '<td class="hdr-right">' + unitC + '|' + unitF + ' ' + wxIcon + ' ' + dateLabel + '</td>' +
        '</tr></table>');

    /* ---- Vars left, score right ---- */
    html += '<table class="vars-row"><tr><td>';

    html += '<table class="vars">';
    for (var v = 0; v < VAR_LIST.length; v++) {
        var vn = VAR_LIST[v];
        if (hideVars[vn]) continue;
        var vi = today.vars[vn];
        if (!vi) continue;
        var cls = unusualClass(vi.raw);
        html += '<tr' + (cls ? ' class="' + cls + '"' : '') + '>';
        html += '<td class="vi">' + getVarIconEink(vn) + '</td>';
        html += '<td>' + fmtVal(vn, vi.value, units) + '</td>';
        html += '<td class="pct">' + pctPretty(vi.raw) + '</td>';
        html += '</tr>';
    }
    html += '</table>';

    html += '</td><td class="score-box">';
    html += '<div class="score-weirdther">WEIRDTHER</div>';
    if (today.weirdther >= 75) {
        html += '<div><span class="score-num-inv">' + today.weirdther + '</span></div>';
    } else {
        html += '<div class="score-num">' + today.weirdther + '</div>';
    }
    html += '<div class="score-lbl">' + label + '</div>';
    // html += '<div class="score-freq">' + genOnceEvery(today.maxPercentile, startYear, endYear) + '</div>';
    html += '<div class="score-refresh">' + formatTime(new Date()) + '</div>';
    html += '</td></tr></table>';

    /* ---- Forecast table with values, clickable days ---- */
    html += '<table class="fc">';
    html += '<tr><th></th><th class="day-col">Day</th><th>' + getVarIconEink("temperature_2m_max") + '</th><th>' + getVarIconEink("temperature_2m_min") + '</th>';
    if (!hideRain) html += '<th>' + getVarIconEink("rain_sum") + '</th>';
    if (!hideSnow) html += '<th>' + getVarIconEink("snowfall_sum") + '</th>';
    html += '<th>' + getVarIconEink("wind_speed_10m_max") + '</th><th>' + getVarIconEink("sunshine_duration") + '</th><th>W</th></tr>';

    for (var d = 0; d < dayScores.length; d++) {
        var ds = dayScores[d];
        var isSelectedRow = (ds.date === selectedDate);
        var isActualToday = (ds.date === nowStr);
        var dayLabel = isActualToday ? "Today" : formatDateShort(ds.date);
        var rowWxCode = weatherCodes[ds.date];
        var rowIcon = getWeatherIconEink(rowWxCode)
        var link = buildDateLink(ds.date);

        var cTempMax = ds.vars["temperature_2m_max"] ? unusualClass(ds.vars["temperature_2m_max"].raw) : "";
        var cTempMin = ds.vars["temperature_2m_min"] ? unusualClass(ds.vars["temperature_2m_min"].raw) : "";
        var cWind = ds.vars["wind_speed_10m_max"] ? unusualClass(ds.vars["wind_speed_10m_max"].raw) : "";
        var cSun = ds.vars["sunshine_duration"] ? unusualClass(ds.vars["sunshine_duration"].raw) : "";
        var sunPct = Math.round(ds.sunshinePct) + "%";

        html += '<tr' + (isSelectedRow ? ' style="border-top:2px solid #000;border-bottom:2px solid #000"' : '') + '>';
        html += '<td class="icon-col" title="' + (rowWxCode != null ? weatherCodeToDescription(rowWxCode) : "") + '">' + rowIcon + '</td>';
        html += '<td class="day-col"><a href="' + link + '"' + (isSelectedRow ? ' style="font-weight:bold"' : '') + '>' + dayLabel + '</a></td>';
        html += '<td' + (cTempMax ? ' class="' + cTempMax + '"' : '') + '>' + Math.round(ds.tempMax) + '</td>';
        html += '<td' + (cTempMin ? ' class="' + cTempMin + '"' : '') + '>' + Math.round(ds.tempMin) + '</td>';
        if (!hideRain) {
            var cRain = ds.vars["rain_sum"] ? unusualClass(ds.vars["rain_sum"].raw) : "";
            html += '<td' + (cRain ? ' class="' + cRain + '"' : '') + '>' + ds.rain.toFixed(1) + '</td>';
        }
        if (!hideSnow) {
            var cSnow = ds.vars["snowfall_sum"] ? unusualClass(ds.vars["snowfall_sum"].raw) : "";
            html += '<td' + (cSnow ? ' class="' + cSnow + '"' : '') + '>' + ds.snow.toFixed(1) + '</td>';
        }
        html += '<td' + (cWind ? ' class="' + cWind + '"' : '') + '>' + Math.round(ds.wind) + '</td>';
        html += '<td' + (cSun ? ' class="' + cSun + '"' : '') + '>' + sunPct + '</td>';
        html += '<td' + (ds.weirdther >= 75 ? ' class="bld"' : '') + '>' + ds.weirdther + '</td>';
        html += '</tr>';
    }
    html += '</table>';

    show("results", html);
}

/* ========== ROTATION ========== */

function setupRotation(angle, zoom) {
    var deg = parseInt(angle, 10);
    if (isNaN(deg)) return;
    if (!zoom || zoom <= 0) zoom = 1;
    var el = document.getElementById("wrapper");
    if (!el) return;
    var w = window.innerWidth || document.documentElement.clientWidth || screen.width || 600;
    var h = window.innerHeight || document.documentElement.clientHeight || screen.height || 800;
    /* For 90/270 rotation, swap and scale wrapper dimensions */
    var a = Math.abs(deg % 360);
    if (a === 90 || a === 270) {
        var wrapW = Math.round(h / zoom);
        var wrapH = Math.round(w / zoom);
        el.style.width = wrapW + "px";
        el.style.height = wrapH + "px";
        el.style.position = "absolute";
        el.style.left = Math.round((w - wrapW) / 2) + "px";
        el.style.top = Math.round((h - wrapH) / 2) + "px";
        el.style.overflow = "hidden";
    }
    var xf = "rotate(" + deg + "deg)";
    if (zoom !== 1) xf += " scale(" + zoom + ")";
    el.style.webkitTransformOrigin = "50% 50%";
    el.style.webkitTransform = xf;
    el.style.transformOrigin = "50% 50%";
    el.style.transform = xf;
}

/* ========== MAIN FLOW ========== */

function loadWeather(lat, lon, units, dateStr) {
    currentLat = lat;
    currentLon = lon;
    currentUnits = units;
    currentDateStr = dateStr;
    var date = parseDate(dateStr);
    var delta = DEFAULT_DELTA;
    var endYear = 2030;  // Match app.js climate normal
    var startYear = 2001;  // Match app.js climate normal

    show("error", "");
    show("results", "");
    show("loading", "Loading forecast...");

    fetchForecast(lat, lon, function(err, forecast) {
        if (err || !forecast || !forecast.daily) {
            show("loading", "");
            show("error", "Error loading forecast: " + (err || "no data"));
            return;
        }

        showProgress("Loading current weather...", 10);

        // Compute the date range to fetch historical data for (covers selected date + forecast days)
        var dayBefore = toISODate(new Date(date.getTime() - 86400000));
        var rangeEndDate = toISODate(new Date(date.getTime() + (NUM_FORECAST_DAYS - 1) * 86400000));
        var forecastStart = dayBefore;
        var forecastEnd = rangeEndDate;
        // Extend range to cover forecast bounds if the selected date is within them
        if (forecast.daily.time[0] < forecastStart) forecastStart = forecast.daily.time[0];
        if (forecast.daily.time[forecast.daily.time.length - 1] > forecastEnd) forecastEnd = forecast.daily.time[forecast.daily.time.length - 1];

        fetchHistoricalRange(lat, lon, forecastStart, forecastEnd, function(err, currentHistorical) {
            showProgress("Loading historical data for comparison...", 30);
            if (!currentHistorical) {
                console.log("Using forecast data for current dates (archive API not available for recent dates)");
            }

            // Use selected date as center, but fetch wider range to cover all forecast dates
            // Each forecast day will use its own ±delta window from this wider dataset
            var widerDelta = delta + NUM_FORECAST_DAYS - 1;  // Cover selected ±delta + all forecast days
            console.log("Historical data: center=" + dateStr + ", widerDelta=" + widerDelta + " (covers all forecast dates " + forecastStart + " to " + forecastEnd + ")");

            fetchAllHistorical(lat, lon, date, widerDelta, startYear, endYear,
                function(done, total) {
                    showProgress("Loading historical data...", 30 + (done / total) * 70);
                },
                function(err, results) {
                    var grouped = groupAllHistorical(results || []);
                    show("loading", "");
                    if (err || !grouped || !grouped.time || grouped.time.length === 0) {
                        show("error", "Error loading historical data.");
                        return;
                    }

                    // Save weather_code from forecast before merge (merge drops non-VAR_LIST fields)
                    var forecastWeatherCodes = {};
                    if (forecast.daily.weather_code) {
                        for (var wi = 0; wi < forecast.daily.time.length; wi++) {
                            forecastWeatherCodes[forecast.daily.time[wi]] = forecast.daily.weather_code[wi];
                        }
                    }

                    // Merge forecast with historical data for current dates
                    var mergedForecast = mergeForecastHistorical(forecast, currentHistorical);

                    // Find selected date in merged data
                    var todayIdx = -1;
                    for (var i = 0; i < mergedForecast.daily.time.length; i++) {
                        if (mergedForecast.daily.time[i] === dateStr) { todayIdx = i; break; }
                    }
                    if (todayIdx === -1) {
                        show("error", "No data available for " + dateStr);
                        return;
                    }

                    /* Hide precip vars only if all zero in forecast AND zero is >= P50 historically */
                    var hideVars = {};
                    var precipVars = ["rain_sum", "snowfall_sum"];
                    for (var pv = 0; pv < precipVars.length; pv++) {
                        var pvn = precipVars[pv];
                        var fcAllZero = true;
                        for (var fi = todayIdx; fi < todayIdx + NUM_FORECAST_DAYS && fi < mergedForecast.daily.time.length; fi++) {
                            if ((mergedForecast.daily[pvn][fi] || 0) > 0) { fcAllZero = false; break; }
                        }
                        if (fcAllZero) {
                            var hist = [];
                            for (var hi = 0; hi < grouped[pvn].length; hi++) {
                                if (grouped[pvn][hi] != null) hist.push(grouped[pvn][hi]);
                            }
                            hist.sort(function(a, b) { return a - b; });
                            var zeroPct = hist.length > 0 ? findPercentileForValue(hist, 0) : 0.5;
                            if (zeroPct[0] >= 0.5) hideVars[pvn] = true;
                        }
                    }

                    var delta = WEIRDTHER_CONFIG.DEFAULT_DELTA;
                    var climateNormal = {start: startYear, end: endYear};
                    console.log("Climate normal range:", climateNormal);
                    console.log("Historical data year range:", grouped.time[0], "to", grouped.time[grouped.time.length - 1]);
                    console.log("Total historical days:", grouped.time.length);
                    // Include yesterday only when selected day is today or in the future
                    var isSelectedTodayOrFuture = (dateStr >= toISODate(new Date()));
                    var startIdx = (isSelectedTodayOrFuture && todayIdx > 0) ? todayIdx - 1 : todayIdx;
                    var numDays = NUM_FORECAST_DAYS + ((isSelectedTodayOrFuture && todayIdx > 0) ? 1 : 0);
                    console.log("Score computation: dateStr=" + dateStr + ", todayIdx=" + todayIdx + ", startIdx=" + startIdx + ", numDays=" + numDays + ", isSelectedTodayOrFuture=" + isSelectedTodayOrFuture);
                    console.log("Merged forecast dates:", mergedForecast.daily.time);
                    // Convert to imperial if needed (both forecast and historical so percentiles stay consistent)
                    if (units === "imperial") {
                        convertToImperial(mergedForecast.daily);
                        convertToImperial(grouped);
                    }
                    convertSunshineToPct(mergedForecast.daily);
                    convertSunshineToPct(grouped);

                    var scores = computeAllDayScores(mergedForecast.daily, startIdx, numDays, grouped, lat, units, delta, climateNormal);
                    if (scores.length === 0) {
                        show("error", "No data to display.");
                        return;
                    }

                    renderAll(scores, units, startYear, endYear, hideVars, dateStr, forecastWeatherCodes);
                }
            );
        });
    });
}

/* ========== AUTO REFRESH ========== */
setInterval(function() { window.location.reload(); }, 3600000);

/* ========== INIT ========== */
var _initDone = false;
window.onload = function() {
    if (_initDone) return;
    _initDone = true;
    var params = parseUrlParams({"location": "Lisbon, Portugal"});
    var loc = params["location"] || "";
    var lat = params["latitude"] || "";
    var lon = params["longitude"] || "";
    var rParam = params["rotation"] || "";
    var sParam = params["scale"] || "";

    /* Get current units - from URL, localStorage, or locale detection */
    if (params["units"]) {
        currentUnits = params["units"];
        setDefaultUnit(params["units"]);
    } else {
        currentUnits = getDefaultUnit();
        /* If this is the first visit (no stored unit), save the detected default */
        if (useCache) {
            try {
                if (!localStorage.getItem('unit')) {
                    setDefaultUnit(currentUnits);
                }
            } catch (e) {}
        }
    }

    currentDateStr = params["date"] || toISODate(new Date());

    var zoom = 1;
    if (sParam) {
        zoom = parseInt(sParam, 10) / 100;
        if (isNaN(zoom) || zoom <= 0) zoom = 1;
    }
    if (rParam) {
        hasRotation = true;
        setupRotation(rParam, zoom);
    } else if (zoom !== 1) {
        var el = document.getElementById("wrapper");
        if (el) el.style.zoom = zoom;
    }

    if (lat && lon) {
        locationName = loc || lat + ", " + lon;
        show("header", locationName);
        loadWeather(parseFloat(lat), parseFloat(lon), currentUnits, currentDateStr);
    } else if (loc) {
        show("header", "Loading...");
        geocode(loc, function(err, gLat, gLon, name) {
            if (err) {
                show("loading", "");
                show("error", "Location not found: " + loc);
                return;
            }
            locationName = name;
            show("header", name);
            loadWeather(parseFloat(gLat), parseFloat(gLon), currentUnits, currentDateStr);
        });
    } else {
        show("header", "WEIRDTHER");
        show("loading", "Add ?location=City to the URL");
    }
};
</script>
</body>
</html>
